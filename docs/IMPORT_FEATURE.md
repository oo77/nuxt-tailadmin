# Функционал импорта студентов

## Обзор

Реализован полноценный функционал массового импорта студентов из Excel файлов с поддержкой:

- Загрузки больших файлов (9000+ строк)
- Предварительного просмотра и анализа данных
- Batch-обработки для производительности
- Real-time отслеживания прогресса
- Автоматического создания/обновления записей по ПИНФЛ
- Детального отчёта об ошибках

## Архитектура

### Backend (Server)

#### API Endpoints

1. **POST /api/students/import/analyze**

   - Анализ Excel файла перед импортом
   - Валидация данных
   - Подсчёт новых/обновляемых записей
   - Возвращает предпросмотр первых 20 строк

2. **POST /api/students/import/execute**

   - Запуск процесса импорта
   - Создание задачи импорта с уникальным jobId
   - Асинхронная batch-обработка данных

3. **GET /api/students/import/status/:jobId**
   - Получение статуса задачи импорта
   - Real-time прогресс (обработано/успешно/ошибки)

#### Утилиты

**server/utils/importUtils.ts**

- `parseExcelFile()` - парсинг Excel файла
- `analyzeImportData()` - анализ и валидация данных
- `executeImport()` - batch-обработка импорта
- `createImportJob()` - создание задачи импорта
- `getImportJobStatus()` - получение статуса задачи

#### Типы

**app/types/import.ts** - общие типы для клиента и сервера:

- `ExcelStudentRow` - структура строки Excel
- `ImportStudentData` - обработанные данные студента
- `ImportAnalysis` - результат анализа файла
- `ImportProgress` - прогресс выполнения импорта
- `ImportStatus` - статусы задачи (pending/processing/completed/failed)

### Frontend (Client)

#### Страница импорта

**app/pages/database/import.vue**

- 4-шаговый процесс импорта:
  1. Загрузка файла
  2. Предпросмотр и анализ
  3. Прогресс импорта
  4. Результаты

#### Компоненты

1. **DatabaseImportUploader.vue**

   - Drag & drop загрузка файлов
   - Валидация формата (.xlsx, .xls)
   - Инструкции и пример структуры

2. **DatabaseImportAnalysis.vue**

   - Визуализация статистики (всего/валидные/новые/обновления)
   - Отображение ошибок валидации
   - Предпросмотр данных в таблице
   - Индикация статуса записей (новые/обновление)

3. **DatabaseImportProgress.vue**

   - Анимированный прогресс-бар
   - Real-time статистика (успешно/создано/обновлено/ошибки)
   - Отображение ошибок в процессе импорта
   - Polling статуса каждые 500ms

4. **DatabaseImportResults.vue**
   - Итоговая статистика импорта
   - Время выполнения и процент успешности
   - Детальный список ошибок
   - Скачивание отчёта об ошибках в CSV
   - Кнопки для нового импорта или перехода к БД

## Структура Excel файла

### Обязательные заголовки (первая строка):

- **ПИНФЛ** - 14 цифр (уникальный идентификатор)
- **ФИО** - полное имя студента
- **Организация** - название организации
- **Служба/Отдел** - отдел (опционально)
- **Должность** - должность студента

### Пример:

```
ПИНФЛ              | ФИО                      | Организация      | Служба/Отдел | Должность
12345678901234     | Иванов Иван Иванович     | ООО "Пример"     | IT отдел     | Разработчик
98765432109876     | Петрова Мария Сергеевна  | АО "Технологии"  | HR отдел     | Менеджер
```

## Логика работы

### 1. Загрузка и анализ

- Пользователь загружает Excel файл
- Файл парсится с помощью библиотеки `xlsx`
- Каждая строка валидируется:
  - ПИНФЛ: 14 цифр
  - ФИО: минимум 3 символа
  - Организация: обязательное поле
  - Должность: обязательное поле
- Подсчитываются новые и существующие студенты по ПИНФЛ

### 2. Предпросмотр

- Отображаются первые 20 валидных записей
- Показываются все ошибки валидации
- Пользователь подтверждает или отменяет импорт

### 3. Импорт

- Создаётся задача импорта с уникальным jobId
- Данные обрабатываются батчами по 100 записей
- Для каждой записи:
  - Если ПИНФЛ существует → обновление данных
  - Если ПИНФЛ новый → создание студента
- Прогресс обновляется в реальном времени

### 4. Результаты

- Отображается итоговая статистика
- Список ошибок (если есть)
- Возможность скачать CSV отчёт об ошибках

## Производительность

### Batch-обработка

- Данные обрабатываются батчами по 100 записей
- Между батчами задержка 50ms для предотвращения блокировки
- Для 9000 строк время импорта: ~5-10 секунд

### Polling

- Статус обновляется каждые 500ms
- Polling останавливается при завершении импорта

### Оптимизации

- Использование Map для быстрого поиска существующих студентов
- Валидация на стороне сервера
- Минимальная нагрузка на клиент

## Навигация

### Доступ к странице импорта:

1. Через кнопку "Импорт студентов" на странице базы данных
2. Прямой URL: `/database/import`

### Кнопка импорта:

- Расположена рядом с кнопкой "Добавить студента"
- Стиль: outline кнопка с иконкой загрузки
- Цвет: primary (синий)

## Обработка ошибок

### Валидация на сервере:

- Проверка формата файла (.xlsx, .xls)
- Валидация структуры данных
- Проверка обязательных полей
- Валидация формата ПИНФЛ

### Отображение ошибок:

- Ошибки валидации показываются перед импортом
- Ошибки импорта отображаются в реальном времени
- Итоговый список ошибок доступен для скачивания

### Типы ошибок:

- "ПИНФЛ не указан"
- "ПИНФЛ должен содержать 14 цифр"
- "ФИО не указано"
- "ФИО слишком короткое"
- "Организация не указана"
- "Должность не указана"

## Безопасность

- Требуется авторизация (middleware: 'auth')
- Валидация на сервере
- Ограничение размера файла (настраивается в Nuxt config)
- Очистка старых задач импорта (старше 1 часа)

## Будущие улучшения

1. **Очередь задач**

   - Использование Redis или RabbitMQ для очереди
   - Поддержка параллельных импортов

2. **Прогресс на уровне БД**

   - Сохранение прогресса в базе данных
   - Возможность возобновления после сбоя

3. **Экспорт**

   - Экспорт студентов в Excel
   - Шаблон для импорта

4. **Расширенная валидация**

   - Проверка дубликатов в файле
   - Валидация формата email/телефона
   - Проверка существования организации

5. **История импортов**
   - Журнал всех импортов
   - Возможность отката импорта

## Технологии

- **Frontend**: Vue 3, Nuxt 4, TypeScript
- **Backend**: Nuxt Server API, H3
- **Excel**: xlsx library
- **Стилизация**: Tailwind CSS
- **Анимации**: CSS transitions, animate-spin, animate-bounce

## Файловая структура

```
app/
├── pages/
│   └── database/
│       └── import.vue                    # Главная страница импорта
├── components/
│   └── database/
│       ├── ImportUploader.vue            # Загрузка файла
│       ├── ImportAnalysis.vue            # Анализ данных
│       ├── ImportProgress.vue            # Прогресс импорта
│       ├── ImportResults.vue             # Результаты
│       └── StudentManagementPanel.vue    # Кнопка импорта
└── types/
    └── import.ts                         # Общие типы

server/
├── api/
│   └── students/
│       └── import/
│           ├── analyze.post.ts           # Анализ файла
│           ├── execute.post.ts           # Запуск импорта
│           └── status/
│               └── [jobId].get.ts        # Статус импорта
├── utils/
│   ├── importUtils.ts                    # Утилиты импорта
│   └── studentStorage.ts                 # Хранилище студентов
└── types/
    └── import.ts                         # Реэкспорт типов
```

## Использование

### Для пользователя:

1. Перейти на страницу "База данных"
2. Нажать кнопку "Импорт студентов"
3. Загрузить Excel файл (drag & drop или выбор файла)
4. Просмотреть анализ и подтвердить импорт
5. Дождаться завершения импорта
6. Просмотреть результаты и скачать отчёт об ошибках (если есть)

### Для разработчика:

```typescript
// Использование API напрямую
const formData = new FormData();
formData.append("file", file);

// Анализ
const analysis = await $fetch("/api/students/import/analyze", {
  method: "POST",
  body: formData,
});

// Импорт
const { jobId } = await $fetch("/api/students/import/execute", {
  method: "POST",
  body: formData,
});

// Статус
const status = await $fetch(`/api/students/import/status/${jobId}`);
```
