# Алгоритм работы системы заявок представителей

**Краткое описание рабочего процесса**

---

## 🎯 Общая схема

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│  ПРЕДСТАВИТЕЛЬ  │ ───► │  ADMIN/MANAGER  │ ───► │    СТУДЕНТЫ     │
│   (Организация) │      │   (Модерация)   │      │  (Зачисление)   │
└─────────────────┘      └─────────────────┘      └─────────────────┘
```

---

## 📋 ЭТАП 1: Регистрация представителя

```
1. Представитель → Telegram-бот → /start
2. Вводит: ФИО, телефон, организация
3. Статус: PENDING (ожидает одобрения)
4. Admin получает уведомление
5. Admin одобряет → создаётся учётная запись (users)
6. Представитель получает логин/пароль для веб-интерфейса
```

**Результат:** Представитель авторизован в системе

---

## 📋 ЭТАП 2: Анонс группы (Admin)

```
1. Admin создаёт/редактирует группу
2. Настраивает анонс:
   - max_capacity = 20 (максимум слушателей)
   - request_deadline = "2026-01-15" (дедлайн заявок)
   - announcement_status = "announced"
   - accepts_requests = true
3. Группа становится видимой для представителей
```

**Результат:** Группа доступна для подачи заявок

---

## 📋 ЭТАП 3: Подача заявки (Представитель)

```
1. Представитель → Веб-интерфейс → "Анонсы групп"
2. Выбирает группу
3. Multi-select сотрудников из списка своей организации
4. Добавляет примечания (опционально)
5. Отправляет заявку
6. Статус заявки: PENDING
```

**Валидации:**
- ✓ Группа принимает заявки
- ✓ Дедлайн не истёк
- ✓ Достаточно свободных мест
- ✓ Сотрудники не зачислены в эту группу
---

## 📋 ЭТАП 4: Бронирование (Admin/Manager)

```
1. Admin видит заявку в панели управления
2. Проверяет список сотрудников
3. Нажимает "Забронировать места"
4. Указывает срок брони (по умолчанию 3 дня)
5. Статус заявки: RESERVED
6. Счётчик reserved_slots группы увеличивается
7. Представитель получает уведомление
```

**Результат:** Места зарезервированы, ожидается PDF

---

## 📋 ЭТАП 5: Загрузка PDF (Представитель)

```
1. Представитель получает уведомление о брони
2. Открывает заявку в личном кабинете
3. Видит статус "Забронировано" и срок брони
4. Загружает PDF (подписанная заявка от руководства)
5. PDF сохраняется в системе
```

**⚠️ Если PDF не загружен до истечения срока:**
- Cron-задача проверяет просроченные брони
- Статус заявки → WITHDRAWN (истекла)
- Счётчик reserved_slots уменьшается
- Представитель получает уведомление

---

## 📋 ЭТАП 6: Финальное одобрение (Admin/Manager)

```
1. Admin видит что PDF загружен
2. Проверяет PDF (подписи, печати)
3. Нажимает "Одобрить"
4. Система автоматически:
   - Статус заявки → APPROVED
   - Зачисляет студентов в группу (study_group_students)
   - Уменьшает reserved_slots
   - Увеличивает current_enrolled
   - Отправляет уведомление представителю
5. Если group.availableSlots <= 0:
   - Группа закрывается для заявок
```

**Результат:** Студенты зачислены в группу

---

## 📊 Статусы заявки

| Статус | Emoji | Описание | Действия |
|--------|-------|----------|----------|
| `pending` | 🟡 | На рассмотрении | Представитель может отозвать |
| `reserved` | 🔵 | Забронировано | Представитель загружает PDF |
| `approved` | ✅ | Одобрена | Студенты зачислены |
| `rejected` | ❌ | Отклонена | Указана причина |
| `withdrawn` | ↩️ | Отозвана | Представителем или истекла |

---

## 📊 Счётчики мест в группе

```
maxCapacity        = 20    # Максимум слушателей
currentEnrolled    = 10    # Уже зачислены
reservedSlots      = 5     # Забронировано
                          ─────
availableSlots     = 5     # Доступно для заявок
```

**Формула:**
```
availableSlots = maxCapacity - currentEnrolled - reservedSlots
```

---

## 🔄 Диаграмма переходов статусов

```
                    ┌─────────────────┐
                    │     PENDING     │
                    │  На рассмотрении│
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│    RESERVED      │ │    REJECTED      │ │   WITHDRAWN      │
│   Забронировано  │ │    Отклонена     │ │    Отозвана      │
└────────┬─────────┘ └──────────────────┘ └──────────────────┘
         │
         │ PDF загружен
         ▼
┌──────────────────┐
│    APPROVED      │
│    Одобрена      │
└──────────────────┘

         │ Бронь истекла
         ▼
┌──────────────────┐
│   WITHDRAWN      │
│    (expired)     │
└──────────────────┘
```

---

## 📱 Telegram-бот команды

| Команда | Описание | Доступ |
|---------|----------|--------|
| `/start` | Регистрация | Все |
| `/status` | Статус регистрации | Все |
| `/groups` | Список анонсированных групп | Одобренные |
| `/requests` | Мои заявки | Одобренные |
| `/students` | Слушатели организации | Одобренные |
| `/help` | Справка | Все |

---

## 🔔 Уведомления

### Для представителя:
- ✅ Регистрация одобрена (+ логин/пароль)
- 🔵 Места забронированы (+ срок брони)
- ⚠️ Бронь истекает через 1 день
- ✅ Заявка одобрена, студенты зачислены
- ❌ Заявка отклонена (+ причина)

### Для Admin/Manager:
- 📩 Новая заявка на регистрацию представителя
- 📩 Новая заявка на обучение
- 📎 PDF загружен к забронированной заявке

---

## 🛠️ Cron-задачи

| Задача | Расписание | Действие |
|--------|------------|----------|
| Проверка истекших броней | Каждый час | Отмена просроченных `reserved` заявок |
| Закрытие групп по дедлайну | Ежедневно | Закрытие групп где `request_deadline` прошёл |
| Напоминание о брони | Ежедневно | Уведомление за 1 день до истечения |

---

## 📁 Ключевые файлы

```
server/
├── repositories/
│   ├── trainingRequestRepository.ts   # Заявки
│   ├── groupRepository.ts             # + анонсы
│   └── representativeRepository.ts    # + создание user
├── services/
│   ├── telegramBotService.ts          # + новые команды
│   └── notificationService.ts         # + уведомления о заявках
└── api/
    ├── training-requests/             # API заявок
    └── groups/announced.get.ts        # Анонсы для представителей

app/
├── layouts/
│   └── representative.vue             # Layout для представителей
├── pages/representative/
│   ├── index.vue                      # Анонсы групп
│   ├── apply/[groupId].vue            # Подача заявки
│   └── requests/index.vue             # Мои заявки
└── components/representative/
    ├── EmployeeMultiSelect.vue        # Выбор сотрудников
    └── RequestStatusBadge.vue         # Статус заявки
```

---

*Краткий алгоритм работы системы заявок представителей*
