# Исправление ошибки авторизации - 401 Unauthorized

## Проблема

API endpoints для студентов возвращали ошибку 401 Unauthorized, потому что они защищены middleware аутентификации, но клиентская часть не отправляла токен авторизации.

## Решение

### 1. Создан composable `useAuthFetch`

**Файл:** `app/composables/useAuthFetch.ts`

Этот composable автоматически добавляет Bearer токен в заголовки всех HTTP запросов:

```typescript
const { authFetch } = useAuthFetch();

// Использование
const response = await authFetch<ResponseType>("/api/students", {
  method: "GET",
});
```

### 2. Обновлены компоненты

Все компоненты, работающие с API студентов, теперь используют `authFetch` вместо `$fetch`:

- ✅ `StudentManagementPanel.vue` - все CRUD операции со студентами
- ✅ `StudentCertificatesModal.vue` - операции с сертификатами

## Настройки авторизации

### Защищенные маршруты

**Файл:** `server/middleware/auth.ts`

API `/api/students` доступен для следующих ролей:

- **ADMIN** - полный доступ
- **MANAGER** - полный доступ
- **TEACHER** - полный доступ

### Публичные маршруты (не требуют авторизации)

- `/api/auth/login`
- `/api/auth/register`
- `/api/auth/refresh`
- `/api/db/test`
- `/api/db/init`

## Как это работает

1. **Вход в систему:**

   - Пользователь входит через `/auth/signin`
   - Токен сохраняется в cookie `auth_token`
   - Срок жизни токена: 7 дней

2. **Авторизованные запросы:**

   - `useAuthFetch` автоматически читает токен из cookie
   - Добавляет заголовок `Authorization: Bearer <token>`
   - Отправляет запрос к API

3. **Проверка на сервере:**
   - Middleware `auth.ts` проверяет наличие токена
   - Верифицирует токен
   - Проверяет роль пользователя
   - Добавляет данные пользователя в `event.context.user`

## Тестирование

### Для тестирования нужно:

1. **Войти в систему:**

   - Перейти на `/auth/signin`
   - Ввести учетные данные
   - После успешного входа токен будет сохранен

2. **Проверить доступ:**
   - Перейти на `/database`
   - Список студентов должен загрузиться
   - Все операции (создание, редактирование, удаление) должны работать

### Если у вас нет учетной записи:

Создайте пользователя с ролью ADMIN, MANAGER или TEACHER через:

- Страницу регистрации `/auth/signup`
- Или напрямую через API `/api/auth/register`

## Возможные проблемы

### Ошибка 401 Unauthorized

**Причина:** Токен отсутствует или истек

**Решение:**

1. Проверьте, что вы вошли в систему
2. Проверьте наличие cookie `auth_token` в DevTools
3. Попробуйте выйти и войти снова

### Ошибка 403 Forbidden

**Причина:** У пользователя недостаточно прав (неправильная роль)

**Решение:**

1. Убедитесь, что ваша роль - ADMIN, MANAGER или TEACHER
2. Роль STUDENT не имеет доступа к `/api/students`

### Токен истек

**Решение:**

- Система автоматически попытается обновить токен через refresh token
- Если это не удастся, пользователь будет перенаправлен на страницу входа

## Структура токена

Токен содержит следующие данные:

```typescript
{
  userId: string;
  email: string;
  role: UserRole; // ADMIN | MANAGER | TEACHER | STUDENT
  iat: number; // Время создания
  exp: number; // Время истечения
}
```

## Безопасность

✅ Токены хранятся в HTTP-only cookies (защита от XSS)
✅ CSRF защита через SameSite cookie attribute
✅ Токены подписаны с использованием JWT_SECRET
✅ Автоматическая проверка истечения токена
✅ Refresh token для обновления access token

## Дополнительная информация

Для более детальной информации см.:

- `docs/DATABASE_STUDENTS.md` - документация по API студентов
- `server/middleware/auth.ts` - логика аутентификации
- `app/composables/useAuth.ts` - клиентская логика авторизации
