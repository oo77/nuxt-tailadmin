# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –º–∏–≥—Ä–∞—Ü–∏–π

## –ü—Ä–æ–±–ª–µ–º–∞

```
Only URLs with a scheme in: file, data, and node are supported by the default ESM loader.
On Windows, absolute paths must be valid file:// URLs. Received protocol 'd:'
```

## –†–µ—à–µ–Ω–∏—è

### ‚úÖ –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ)

**–§–∞–π–ª:** `migrator.ts` (—Ç–µ–∫—É—â–∏–π)

**–ü–æ–¥—Ö–æ–¥:** –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Ç–∏ –ø–µ—Ä–µ–¥ `pathToFileURL`

```typescript
const normalizedPath = normalize(migrationPath).replace(/\\/g, "/");
const fileUrl = pathToFileURL(normalizedPath).href;
const migration = await import(fileUrl);
```

**–ü–ª—é—Å—ã:**

- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ú–∏–Ω—É—Å—ã:**

- ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã `pathToFileURL` –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –û–°
- ‚ö†Ô∏è –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–†–ê–ë–û–¢–ê–ï–¢** (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)

---

### üîÑ –í–∞—Ä–∏–∞–Ω—Ç A: import.meta.url

**–§–∞–π–ª:** `migrator-variant-a.ts`

**–ü–æ–¥—Ö–æ–¥:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `import.meta.url` –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π

```typescript
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const migrationsDir = join(__dirname, "migrations");
const migration = await import(`./migrations/${file}`);
```

**–ü–ª—é—Å—ã:**

- ‚úÖ –ë–æ–ª–µ–µ "–Ω–∞—Ç–∏–≤–Ω—ã–π" –¥–ª—è ESM
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `process.cwd()`
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–π —Å—Ä–µ–¥–µ ESM

**–ú–∏–Ω—É—Å—ã:**

- ‚ö†Ô∏è –í—Å—ë –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü¢ **–•–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç** –¥–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤, –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞ ESM

---

### üöÄ –í–∞—Ä–∏–∞–Ω—Ç B: –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –∫–µ—à–µ–º

**–§–∞–π–ª:** `migrator-variant-b.ts`

**–ü–æ–¥—Ö–æ–¥:** –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π + —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```typescript
let migrationsCache: Migration[] | null = null;

async function loadMigrations(forceReload = false): Promise<Migration[]> {
  if (migrationsCache && !forceReload) {
    return migrationsCache;
  }
  // ... –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
}
```

**–ü–ª—é—Å—ã:**

- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å

**–ú–∏–Ω—É—Å—ã:**

- ‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
- ‚ö†Ô∏è –ù—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –∫–µ—à–µ–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü° **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

### üèÜ –í–∞—Ä–∏–∞–Ω—Ç C: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–µ—Å—Ç—Ä (–°–ê–ú–´–ô –ù–ê–î–ï–ñ–ù–´–ô)

**–§–∞–π–ª:** `migrator-variant-c.ts`

**–ü–æ–¥—Ö–æ–¥:** –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã –±–µ–∑ –¥–∏–Ω–∞–º–∏–∫–∏

```typescript
import * as migration001 from "./migrations/20251215_001_create_users_table.js";
import * as migration002 from "./migrations/20251215_002_seed_admin_user.js";

const MIGRATIONS_REGISTRY: Migration[] = [
  { name: "20251215_001_create_users_table", ...migration001 },
  { name: "20251215_002_seed_admin_user", ...migration002 },
];
```

**–ü–ª—é—Å—ã:**

- ‚úÖ **–ù–ï–¢ –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏** - –≤—Å—ë –∏–∑–≤–µ—Å—Ç–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100% –û–° –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–π
- ‚úÖ TypeScript –≤–∏–¥–∏—Ç –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã
- ‚úÖ Tree-shaking —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ú–∏–Ω—É—Å—ã:**

- ‚ùå –ù—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è—Ç—å –∫–∞–∂–¥—É—é –º–∏–≥—Ä–∞—Ü–∏—é
- ‚ùå –ú–µ–Ω–µ–µ –≥–∏–±–∫–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** üü¢ **–õ–£–ß–®–ò–ô** –¥–ª—è production –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

---

## –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –¢–µ–∫—É—â–µ–µ     | –í–∞—Ä–∏–∞–Ω—Ç A   | –í–∞—Ä–∏–∞–Ω—Ç B   | –í–∞—Ä–∏–∞–Ω—Ç C   |
| ------------------------- | ----------- | ----------- | ----------- | ----------- |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**            | üü° –°—Ä–µ–¥–Ω—è—è  | üü¢ –•–æ—Ä–æ—à–∞—è  | üü° –°—Ä–µ–¥–Ω—è—è  | üü¢ –û—Ç–ª–∏—á–Ω–∞—è |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**    | üü° –°—Ä–µ–¥–Ω—è—è  | üü° –°—Ä–µ–¥–Ω—è—è  | üü¢ –•–æ—Ä–æ—à–∞—è  | üü¢ –û—Ç–ª–∏—á–Ω–∞—è |
| **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**         | üü¢ –ü–æ–ª–Ω–∞—è   | üü¢ –ü–æ–ª–Ω–∞—è   | üü¢ –ü–æ–ª–Ω–∞—è   | üî¥ –†—É—á–Ω–∞—è   |
| **–ö—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å** | üü¢ –î–∞       | üü¢ –î–∞       | üü¢ –î–∞       | üü¢ –î–∞       |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–¥–∞**        | üü¢ –ü—Ä–æ—Å—Ç–∞—è  | üü° –°—Ä–µ–¥–Ω—è—è  | üü° –°—Ä–µ–¥–Ω—è—è  | üü¢ –ü—Ä–æ—Å—Ç–∞—è  |
| **–ü—Ä–æ–±–ª–µ–º—ã —Å –ø—É—Ç—è–º–∏**     | üü° –í–æ–∑–º–æ–∂–Ω—ã | üü° –í–æ–∑–º–æ–∂–Ω—ã | üü° –í–æ–∑–º–æ–∂–Ω—ã | üü¢ –ù–µ—Ç      |

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

- **–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ** –∏–ª–∏ **–í–∞—Ä–∏–∞–Ω—Ç A** - —É–¥–æ–±–Ω–æ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –î–ª—è production:

- **–í–∞—Ä–∏–∞–Ω—Ç C** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏

### –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

- **–í–∞—Ä–∏–∞–Ω—Ç B** - –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–π –º–Ω–æ–≥–æ –∏ –æ–Ω–∏ —á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è

---

## –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å?

1. **–ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚Üí –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å ‚úÖ
2. **–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –í–∞—Ä–∏–∞–Ω—Ç C üèÜ
3. **–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–∏–±–∫–æ—Å—Ç—å ESM** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –í–∞—Ä–∏–∞–Ω—Ç A üîÑ
4. **–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –í–∞—Ä–∏–∞–Ω—Ç B üöÄ

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–î–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**

–ü–æ—Å–∫–æ–ª—å–∫—É —Å–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ —Å —Ç–µ–∫—É—â–∏–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º, —è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é:

1. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ:** –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (—Ä–∞–±–æ—Ç–∞–µ—Ç) ‚úÖ
2. **–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ:** –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ **–í–∞—Ä–∏–∞–Ω—Ç C** –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ üèÜ
3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ORM (Prisma, Drizzle) —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –º–∏–≥—Ä–∞—Ü–∏–π

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –í–∞—Ä–∏–∞–Ω—Ç C?

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `migrator-variant-c.ts` ‚Üí `migrator.ts`
2. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:
   - –î–æ–±–∞–≤–∏—Ç—å `import * as migrationXXX from './migrations/...'`
   - –î–æ–±–∞–≤–∏—Ç—å –≤ `MIGRATIONS_REGISTRY`
3. –í—Å—ë! –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏ –Ω–∏–∫–æ–≥–¥–∞ üéâ
