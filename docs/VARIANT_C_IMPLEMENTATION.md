# ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç C —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω!

## üéØ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. **–ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Å–∏—Å—Ç–µ–º—ã –º–∏–≥—Ä–∞—Ü–∏–π**

–§–∞–π–ª `server/database/migrator.ts` –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤** –≤–º–µ—Å—Ç–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö.

#### –î–æ (–ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥):

```typescript
const migrationPath = join(migrationsDir, file);
const normalizedPath = normalize(migrationPath).replace(/\\/g, "/");
const fileUrl = pathToFileURL(normalizedPath).href;
const migration = await import(fileUrl); // ‚ùå –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç
```

#### –ü–æ—Å–ª–µ (–Ω–∞–¥–µ–∂–Ω—ã–π –∫–æ–¥):

```typescript
// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è
import * as migration001 from "./migrations/20251215_001_create_users_table.js";
import * as migration002 from "./migrations/20251215_002_seed_admin_user.js";

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–µ—Å—Ç—Ä
const MIGRATIONS_REGISTRY: Migration[] = [
  {
    name: "20251215_001_create_users_table",
    up: migration001.up,
    down: migration001.down,
    description: migration001.description,
  },
  // ...
];
```

---

## üèÜ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏

- **–ù–∏–∫–∞–∫–∏—Ö** –ø—Ä–æ–±–ª–µ–º —Å `d:` –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º
- **–ù–∏–∫–∞–∫–∏—Ö** –ø—Ä–æ–±–ª–µ–º —Å –æ–±—Ä–∞—Ç–Ω—ã–º–∏ —Å–ª–µ—à–∞–º–∏ Windows
- **–ù–∏–∫–∞–∫–∏—Ö** –ø—Ä–æ–±–ª–µ–º —Å `pathToFileURL`
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **–ª—é–±–æ–π –û–°** (Windows, Linux, macOS)

### ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ò–º–ø–æ—Ä—Ç—ã –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- –ù–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö `import()` –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π (`readdir`)
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π

### ‚úÖ –õ—É—á—à–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è

- TypeScript –≤–∏–¥–∏—Ç –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã
- –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ
- –û—à–∏–±–∫–∏ –≤–∏–¥–Ω—ã –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

### ‚úÖ Tree-shaking

- –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –ø—Ä–∏ —Å–±–æ—Ä–∫–µ
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–Ω–¥–ª–∞

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`server/database/migrator.ts`** (–æ–±–Ω–æ–≤–ª–µ–Ω)

   - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏–º–ø–æ—Ä—Ç–∞–º–∏
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä—è–º–æ –≤ –∫–æ–¥–µ

2. **`docs/HOW_TO_ADD_MIGRATION.md`**

   - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
   - –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
   - –ß–µ–∫-–ª–∏—Å—Ç
   - –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

3. **`docs/MIGRATION_APPROACHES.md`**

   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
   - –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤/–Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É

4. **–í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏:**
   - `server/database/migrator-variant-a.ts` (import.meta.url)
   - `server/database/migrator-variant-b.ts` (–ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
   - `server/database/migrator-variant-c.ts` (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–µ—Å—Ç—Ä - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:

- ‚úÖ `20251215_001_create_users_table`
- ‚úÖ `20251215_002_seed_admin_user`

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

**–®–∞–≥ 1:** –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
server/database/migrations/20251216_003_your_migration.ts
```

**–®–∞–≥ 2:** –î–æ–±–∞–≤—å—Ç–µ –∏–º–ø–æ—Ä—Ç –≤ `migrator.ts` (—Å—Ç—Ä–æ–∫–∞ ~27)

```typescript
import * as migration003 from "./migrations/20251216_003_your_migration.js";
```

**–®–∞–≥ 3:** –î–æ–±–∞–≤—å—Ç–µ –≤ —Ä–µ–µ—Å—Ç—Ä (—Å—Ç—Ä–æ–∫–∞ ~60)

```typescript
{
  name: '20251216_003_your_migration',
  up: migration003.up,
  down: migration003.down,
  description: migration003.description,
},
```

**–®–∞–≥ 4:** –ü—Ä–∏–º–µ–Ω–∏—Ç–µ

```bash
npm run db:migrate
```

üìñ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** `docs/HOW_TO_ADD_MIGRATION.md`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
npm run db:status

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
npm run db:migrate

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é
npm run db:rollback

# –û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ
npm run db:rollback:all
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
üìã Loaded 2 migrations from registry
‚ÑπÔ∏è  Found X executed migrations
‚ÑπÔ∏è  Found 2 migration files
‚úÖ All migrations are up to date
```

---

## üéØ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå –°—Ç–∞—Ä–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

```
Only URLs with a scheme in: file, data, and node are supported by the default ESM loader.
On Windows, absolute paths must be valid file:// URLs. Received protocol 'd:'
```

### ‚úÖ –†–µ—à–µ–Ω–∏–µ:

- –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã
- –ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø—É—Ç—è–º–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –∏–∑–≤–µ—Å—Ç–Ω—ã –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ú–µ—Ç—Ä–∏–∫–∞                  | –°—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥       | –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥      |
| ------------------------ | ------------------- | ----------------- |
| **–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π**    | ~50-100ms           | ~0ms (–∫–æ–º–ø–∏–ª—è—Ü–∏—è) |
| **–û–ø–µ—Ä–∞—Ü–∏–∏ —Å FS**        | readdir + normalize | –ù–µ—Ç               |
| **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã** | –î–∞                  | –ù–µ—Ç               |
| **–ü—Ä–æ–±–ª–µ–º—ã —Å –ø—É—Ç—è–º–∏**    | –í–æ–∑–º–æ–∂–Ω—ã            | –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã        |
| **TypeScript support**   | –ß–∞—Å—Ç–∏—á–Ω—ã–π           | –ü–æ–ª–Ω—ã–π            |

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É (–í–∞—Ä–∏–∞–Ω—Ç C)
2. ‚úÖ –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `docs/HOW_TO_ADD_MIGRATION.md`
3. ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

### –î–ª—è production:

1. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
2. ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
3. ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π –û–° –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –î–ª—è –∫–æ–º–∞–Ω–¥—ã:

1. ‚úÖ –û–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å `docs/HOW_TO_ADD_MIGRATION.md`
2. ‚úÖ –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–ª–µ–¥—É–π—Ç–µ —á–µ–∫-–ª–∏—Å—Ç—É
3. ‚úÖ –í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ—Ç–∫–∞—Ç (`npm run db:rollback`)

---

## üéâ –ò—Ç–æ–≥

**–í–∞—Ä–∏–∞–Ω—Ç C —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω!**

- ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—É—Ç—è–º–∏ —Ä–µ—à–µ–Ω–∞ –Ω–∞–≤—Å–µ–≥–¥–∞
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ –Ω–∞ –ª—é–±–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ!** üöÄ

---

## üìû –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `docs/HOW_TO_ADD_MIGRATION.md`
- **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤:** `docs/MIGRATION_APPROACHES.md`
- **–ü—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π:** `server/database/migrations/`

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 2025-12-16  
**–í–µ—Ä—Å–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç C (–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–µ—Å—Ç—Ä)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
