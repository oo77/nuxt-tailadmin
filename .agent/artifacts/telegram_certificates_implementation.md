# Реализация функционала сертификатов и разрешений для Telegram-бота

## Дата: 2025-12-29

## Обзор изменений

Реализована полная система управления сертификатами через Telegram-бот с системой разрешений для представителей организаций.

---

## 1. Миграция БД (20251229_023_certificate_validity_and_permissions)

### Добавленные поля:

#### Таблица `courses`:

- `certificate_validity_months` (INT, NULL) - Срок действия сертификата в месяцах (NULL = бессрочный)

#### Таблица `issued_certificates`:

- `expiry_date` (DATE, NULL) - Дата окончания действия сертификата
- `is_sent_via_telegram` (BOOLEAN, DEFAULT FALSE) - Был ли отправлен через Telegram
- `sent_at` (DATETIME(3), NULL) - Дата и время отправки через Telegram

#### Таблица `organization_representatives`:

- `permissions` (JSON) - Разрешения представителя:
  ```json
  {
    "can_view_students": true,
    "can_view_schedule": true,
    "can_view_certificates": true,
    "can_request_certificates": true
  }
  ```
- `can_receive_notifications` (BOOLEAN, DEFAULT TRUE) - Может получать уведомления

### Автоматические действия миграции:

- Установка дефолтных разрешений для существующих представителей
- Вычисление `expiry_date` для существующих сертификатов на основе настроек курса
- Добавление нового типа сущности `CERTIFICATE_DATABASE` в `activity_logs`

---

## 2. Система разрешений

### Интерфейс RepresentativePermissions:

```typescript
export interface RepresentativePermissions {
  can_view_students: boolean; // Просмотр списка слушателей
  can_view_schedule: boolean; // Просмотр расписания
  can_view_certificates: boolean; // Просмотр сертификатов
  can_request_certificates: boolean; // Запрос файлов сертификатов
}
```

### Дефолтные разрешения:

Все разрешения по умолчанию установлены в `true` для новых представителей.

---

## 3. Telegram-бот: Команды с проверкой разрешений

### `/students` - Список слушателей

- **Требуемое разрешение**: `can_view_students`
- **Функционал**: Показывает список всех слушателей организации

### `/schedule` - Расписание

- **Требуемое разрешение**: `can_view_schedule`
- **Функционал**: Показывает расписание на неделю для групп организации

### `/certificates` - Сертификаты

- **Требуемое разрешение**: `can_view_certificates`
- **Функционал**:
  - Показывает список всех сертификатов слушателей организации
  - Отображает статус (выдан/отозван)
  - Показывает процент посещаемости
  - Показывает статус прохождения (прошёл/не прошёл)
  - Если есть разрешение `can_request_certificates`, добавляет кнопки для запроса файлов

---

## 4. Отправка сертификатов через Telegram

### Функция `handleSendAllCertificates`:

- Отправляет до 10 сертификатов за раз
- Проверяет наличие PDF файлов
- Отмечает отправленные сертификаты в БД (`is_sent_via_telegram = true`)
- Логирует все действия

### Функция `handleSendCertificate`:

- Отправляет конкретный сертификат по ID
- Проверяет принадлежность сертификата к организации представителя
- Отправляет PDF с подписью (имя слушателя, номер, курс)

### Безопасность:

- Проверка разрешения `can_request_certificates`
- Проверка принадлежности сертификата к организации
- Проверка существования файла перед отправкой

---

## 5. Срок действия сертификатов

### Настройка в курсе:

При создании/редактировании курса можно указать `certificate_validity_months`.

### Автоматическое вычисление:

При выдаче сертификата:

```typescript
if (course.certificateValidityMonths) {
  expiryDate = new Date(issueDate);
  expiryDate.setMonth(expiryDate.getMonth() + course.certificateValidityMonths);
}
```

### Отображение:

- В списке сертификатов Telegram-бота
- В базе данных сертификатов (веб-интерфейс)
- В деталях сертификата

---

## 6. Обновлённые репозитории

### `representativeRepository.ts`:

- Добавлен интерфейс `RepresentativePermissions`
- Обновлён `Representative` с полями `permissions` и `canReceiveNotifications`
- Обновлён маппинг с дефолтными разрешениями
- Обновлены функции создания/обновления представителей

### `courseRepository.ts`:

- Добавлено поле `certificateValidityMonths` в интерфейс `Course`
- Обновлены функции создания/обновления курсов

### `certificateTemplateRepository.ts`:

- Добавлен параметр `expiryDate` в `createIssuedCertificate`
- Обновлён SQL запрос для записи срока действия

---

## 7. API изменения

### `POST /api/certificates/issue/[groupId]`:

- Автоматически вычисляет `expiry_date` на основе настроек курса
- Записывает срок действия при создании сертификата

---

## 8. Telegram-бот: Новые сообщения

Добавлены константы сообщений:

- `NO_CERTIFICATES` - Нет сертификатов
- `CERTIFICATES_HEADER` - Заголовок списка сертификатов
- `CERTIFICATE_SENT` - Сертификат отправлен
- `CERTIFICATE_SEND_ERROR` - Ошибка отправки
- `CERTIFICATE_REQUEST_RECEIVED` - Запрос принят
- `CERTIFICATE_SENDING_LIMIT` - Лимит отправки (10 шт)

---

## 9. Функция форматирования сертификатов

### `formatCertificatesList`:

```typescript
function formatCertificatesList(certificates: FormattedCertificate[]): string {
  // Группирует по статусу
  // Показывает: имя, номер, курс, дату выдачи, статус прохождения, посещаемость
  // Добавляет эмодзи-индикаторы
}
```

### `FormattedCertificate`:

```typescript
interface FormattedCertificate {
  id: string;
  studentName: string;
  certificateNumber: string;
  courseName: string;
  groupCode: string;
  issueDate: string;
  status: "draft" | "issued" | "revoked";
  pdfFileUrl: string | null;
  hasPassed: boolean; // Прошёл ли обучение
  attendancePercent: number; // Процент посещаемости
}
```

---

## 10. Логирование

Все действия с сертификатами логируются:

- Просмотр списка сертификатов
- Отправка сертификатов через Telegram
- Обновление статуса отправки в БД

---

## 11. Использование

### Для администратора:

1. Создать курс с указанием срока действия сертификатов (опционально)
2. Настроить разрешения для представителей организаций
3. Выдать сертификаты слушателям

### Для представителя организации:

1. Зарегистрироваться в Telegram-боте
2. Дождаться одобрения администратором
3. Использовать команды:
   - `/students` - просмотр слушателей
   - `/schedule` - просмотр расписания
   - `/certificates` - просмотр и запрос сертификатов

---

## 12. Безопасность

### Проверки на каждом уровне:

1. **Статус представителя**: Должен быть `approved`
2. **Разрешения**: Проверка конкретного разрешения для каждой команды
3. **Принадлежность данных**: Сертификаты проверяются на принадлежность к организации
4. **Существование файлов**: Проверка наличия PDF перед отправкой

### Сообщения об ошибках:

- Понятные сообщения для пользователя
- Детальное логирование для администратора

---

## 13. Ограничения

- **Отправка сертификатов**: Максимум 10 за раз (защита от спама)
- **Формат файлов**: Только PDF
- **Размер файлов**: Ограничен Telegram API (~50MB)

---

## 14. Дальнейшие улучшения

### Возможные расширения:

1. Уведомления о скором истечении срока действия сертификата
2. Автоматическая отправка сертификатов при выдаче
3. Статистика по отправленным сертификатам
4. Групповая отправка по фильтрам
5. Экспорт списка сертификатов в Excel через бота
6. QR-код для быстрой проверки сертификата

---

## 15. Миграция данных

### Запуск миграции:

```bash
npm run db:migrate
```

### Откат (если необходимо):

```bash
npm run db:rollback
```

### Проверка статуса:

```bash
npm run db:status
```

---

## Заключение

Реализована полная система управления сертификатами через Telegram-бот с:

- ✅ Системой разрешений для представителей
- ✅ Сроком действия сертификатов
- ✅ Отправкой PDF файлов через Telegram
- ✅ Отслеживанием статуса отправки
- ✅ Детальным логированием
- ✅ Безопасностью на всех уровнях

Все изменения обратно совместимы и не нарушают существующий функционал.
